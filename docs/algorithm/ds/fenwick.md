---
title: 树状数组
createTime: 2025/12/19 20:14:40
permalink: /algorithm/ds/fenwick/
---

## _Intro_
普通的树状数组支持两个操作：
1.  单点插入
2.  区间查询前缀和

也就是说，树状数组维护的必须满足可减性。  

### _Proof_
对于一个数 $x$，我们可以将其二进制分解成：
$$
x=2^{i_1}+2^{i_2}+\cdots+2^{i_m}
$$
令 $i_1>i_2>\cdots>i_m$，那么区间 $[1,x]$ 可以划分成 $\log x$ 个小区间：  
$1$.  长度为 $2^{i_1}$ 的小区间 $[1,2^{i_1}]$  
$2$.  长度为 $2^{i_2}$ 的小区间 $[2^{i_1}+1,2^{i_1}+2^{i_2}]$  
$\cdots$  
$m$.  长度为 $2^{i_m}$ 的小区间 $[2^{i_1}+2^{i_2}+\cdots+2^{i_{m-1} }+1,2^{i_1}+2^{i_2}+\cdots+2^{i_m}]$  

容易发现，这些区间的共同特点是：若区间结尾为 $R$，区间长度就是 $\text{lowbit}(R)$。  
由于每个区间都被右端点唯一确定，所以最多只有 $n$ 个区间。  

在数学层面上，我们已经能够知道每个区间是啥，令 $c_i=\sum _{j=i-\text{lowbit}(i)+1}^i$  
那么怎么找到一个区间的子区间呢？$x$ 一定能被表示成 $(\cdots 010 \cdots 00)_2$ 这样的二进制数，这个时候的 $x-\text{lowbit}(x)+1$ 其实就是 $(\cdots 000 \cdots 01)_2$，且 $x-1$ 是 $(\cdots 001 \cdots 11)_2$，也就是我们可以通过每次给 $x-1$ 去掉最后一位，得到的就是 $x$ 的一个子区间。  
同样的，我们可以找到 $x$ 的父区间，若 $x$ 是 $(\cdots 010 \cdots 0)_2$，它的父区间就是 $(\cdots 100 \cdots 0)_2$，因为 $x$ 二进制有 $\log x$ 位，所以一次操作是 $O(\log n)$ 的。

## _Examples_
### AcWing 241. 楼兰图腾 {#acwing-241}
[题目传送门](https://www.acwing.com/problem/content/243/)  
这道题就是树状数组求逆序对简单应用。  
考虑单点插入 $y_j(j<i)$，那么查询 $y_i-1$ 时所求得的就是前面比 $y_i$ 小的数。  
由于要求 v 和 ^ 的形状，所以可以看中间点左右两边，用乘法原理算。  
由于 $y$ 是一个排列，所以不用进行离散化，直接做即可。  

### AcWing 243. 一个简单的整数问题2 {acwing-243}
[题目传送门](https://www.acwing.com/problem/content/244/)  
在数组 $a$ 的差分数组 $b$ 中，想要对 $a$ 的 $[L,R]$ 区间加 $c$ 只需要在 $b_L$ 加 $c$，$b_{R+1}$ 减 $c$。  
如果要查询 $[1,x]$，实际就是求 $\sum\limits _{i=1}^x\sum\limits _{j=1}^i b_j$。  
很明显不能直接求，考虑将其展开：  
$1$.  $d_1$  
$2$.  $d_1+d_2$  
$\cdots$  
$x$.  $d_1+d_2+\cdots+d_x$  

还是不好求，并且我们需要将其转换为前缀和的形式，考虑将空缺部分补齐，会发现整个矩阵就是 $(x+1)\times\sum _{i=1}^x d_i$，需要减去的是 $d_1+2d_2+\cdots+xd_x$，也就是 $\sum _{i=1}^x id_i$，这样就可以用两个树状数组维护了。  