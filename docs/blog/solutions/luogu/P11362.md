---
title: Luogu P11362 [NOIP2024] 遗失的赋值
createTime: 2025/11/23 20:16:17
permalink: /blog/vz0g2hbs/
tags:
    - Luogu
    - NOIP
    - 组合计数
---

## 题目大意
[题目传送门](https://www.luogu.com.cn/problem/P11362)  
给定 $n$ 个变量，记作 $x_1$ 到 $x_n$，每个变量可以取 $1$ 至 $v$ 中任意整数。  
另外有 $m$ 个形如 $(c_j,d_j)$ 的一元限制，意思是 $x_{c_j}=d_j$。  
定义二元限制 $(a_i,b_i)$ 表示若 $x_i=a_i$，则 $x_{i+1}=b_i$；若 $x_i\neq a_i$，则不做限制。  
需要求出所有给变量赋值使其满足所有限制的**二元限制的取值组合**的方案数，答案对 $10^9+7$ 取模。  

## _Solution_
首先考虑一元限制对结果的影响，会发现所有的一元限制把序列隔成了若干段，任意取一个 $c_i$。  
容易发现，此时可以将 $[c_i,c_{i+1}-1]$ 视作一段，考虑统计其中的方案数，正难则反，考虑什么情况下不满足这个限制。  
如果 $x_{c_i}=a_{c_i}$ 且 $x_{c_i+1}=b_{c_i}$ 依次类推，直到最后一个 $x_{c_{i+1} }\neq b_{c_{i+1}-1}$，这个情况就是不正确的，中间共 $c_{i+1}-c_i$ 个数，除了最后一个只有 $v-1$ 种取值，其他都有 $v$ 种取值，不可行方案数就是 $v^{c_{i+1}-c_i-1}\times (v-1)$，可行方案数为 $v^{2\times (c_{i+1}-c_i)}-v^{c_{i+1}-c_i-1}\times (v-1)$，其中一对二元限制有 $v^2$ 种选择。  
这样我们就顺利统计完了方案数，至于最开头和最后则是直接加上即可。  

## _Code_

```cpp :collapsed-lines
#include <cstdio>
#include <algorithm>
#include <iostream>
#include <vector>

#define x first
#define y second

using namespace std;

typedef long long LL;
typedef pair<LL,LL> PLL;

const int M = 1e5+10;
const LL MOD = 1e9+7;

PLL g[M];

LL qpow(LL a , LL b) {
	LL res = 1;
	while(b) {
		if(b & 1) res = res * a % MOD;
		a = a * a % MOD;
		b >>= 1;
	}
	return res;
}

void slove() {
	LL n; int m; LL v;
	scanf("%lld%d%lld" , &n , &m , &v);
	for(int i = 1 ; i <= m ; i ++) {
		scanf("%lld%lld" , &g[i].x , &g[i].y);
	}
	sort(g+1 , g+m+1 , [](const PLL& a , const PLL& b) {
		return a.x < b.x;
	});
	vector<LL> f;
	for(int i = 1 ; i <= m ; i ++) {
		if(g[i].x != g[i-1].x) {
			f.push_back(g[i].x);
		} else if(g[i].y != g[i-1].y) {
			puts("0"); return;
		}
	}
	
	LL res = qpow(v , (f[0]-1)*2);
	for(int i = 1 ; i < (int)f.size() ; i ++) {
		LL tmp = qpow(v , (f[i]-f[i-1])*2) % MOD;
		tmp -= qpow(v , f[i]-f[i-1]-1)*(v-1)%MOD;
		tmp = (tmp+MOD)%MOD;
		res = (res*tmp) % MOD;
	}
	res = (res*qpow(v , (n-f.back())*2)%MOD)%MOD;
	printf("%lld\n" , res);
	return;
}

int main() {
	int T; scanf("%d" , &T);
	while(T --) slove();
	return 0;
}
```

## 后话
一点[参考文献](https://www.luogu.me/article/9pagx8eg)？